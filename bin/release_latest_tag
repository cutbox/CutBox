#!/bin/sh

PROJECT_DIR=$(git rev-parse --show-toplevel)
RELEASE_NOTES="${PROJECT_DIR}/release_notes.md"
INFOPLIST_FILE="${PROJECT_DIR}/CutBox/CutBox/Info.plist"

VERSION=$(/usr/libexec/PlistBuddy -c \
                                  "Print CFBundleShortVersionString" \
                                  "${INFOPLIST_FILE}")

if [ "${VERSION}" == "$(git tag | tail -1)" ]; then

  echo "ERROR: Current version and latest git tag match."
  exit 1

else

  if [ -f "${RELEASE_NOTES}" ]; then
    MESSAGE=$(< "${RELEASE_NOTES}")
  else
    MESSAGE="CutBox version ${VERSION}"
  fi

  bin/cutbox_make_dmg && \
    mv CutBox.dmg "CutBox.${VERSION}.dmg" && \
    bin/cutbox_hub_release \
      ${VERSION} \
      "CutBox.${VERSION}.dmg" \
      "${MESSAGE}" && \
    bin/clean_release_files

  echo "Released CutBox version: ${VERSION}"

fi
