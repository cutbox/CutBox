#!/bin/bash

github_summary() {
    echo "$1" >> $GITHUB_STEP_SUMMARY
    echo "$1"
}

summary_test() {
    if [[ "$2" == "$3" ]]; then
        echo "$2"
        echo "  equals"
        echo "$3"

        github_summary "$1 - Passed ✅"
    else
        echo "$2"
        echo "  not equal to"
        echo "$3"

        github_summary "$1 - Failed ☠"
    fi
}

cutbox=build/Release/cutbox

cd cutbox_command || exit 1
xcodebuild || exit 1

if [[ ! -e $cutbox ]]; then
    exit 1
fi

github_summary "$($cutbox --help)"

date_hour_ago=$(TZ=UTC gdate -d "-1 hour" +%Y-%m-%dT%H:%M:%SZ)
date_day_ago=$(TZ=UTC gdate -d "-1 day" +%Y-%m-%dT%H:%M:%SZ)

# Fake history item via macos defaults write command line:
defaults write info.ocodo.cutbox historyStore -array-add "<dict><key>string</key><string>Test Passed?</string><key>favorite</key><string>favorite</string></dict>"
defaults write info.ocodo.cutbox historyStore -array-add "<dict><key>string</key><string>Copied Text</string><key>timestamp</key><string>${date_hour_ago}</string></dict>"
defaults write info.ocodo.cutbox historyStore -array-add "<dict><key>string</key><string>Copied text</string><key>timestamp</key><string>${date_day_ago}</string></dict>"

github_summary "# CutBox CLI Tests"

summary_test \
"- Show history items from cutbox command line" \
"$($cutbox)" \
"Test Passed?
Copied Text
Copied text"

summary_test "- --fuzzy text" \
"$($cutbox --fuzzy text)" \
"Copied text"

summary_test "- --fuzzy zoo - no results" \
"$($cutbox --fuzzy zoo)" \
""

summary_test "- --regex Text" \
"$($cutbox --regex Text)" \
"Copied Text"

summary_test "- --regexi Text" \
"$($cutbox --regexi Text)" \
"Copied Text
Copied text"

summary_test "- --favorites" \
"$($cutbox --favorites)" \
"Test Passed?"

summary_test "- --missing-date" \
"$($cutbox --missing-date)" \
"Test Passed?"

summary_test "- --since 61mins" \
"$($cutbox --since 61mins)" \
"Test Passed?
Copied Text"

summary_test "- --since 1.1day" \
"$($cutbox --since 1.1day)" \
"Test Passed?
Copied Text
Copied text"

summary_test "- --before 1.1hour" \
"$($cutbox --before 1.1hour)" \
"Test Passed?
Copied text"

summary_test "- --before 1.1day" \
"$($cutbox --before 1.1day)" \
"Test Passed?"

[[ "$(grep "☠" "$GITHUB_STEP_SUMMARY")" == "" ]]  ||  exit 1
