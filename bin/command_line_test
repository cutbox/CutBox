#!/bin/bash

github_summary() {
    echo "$1" >> $GITHUB_STEP_SUMMARY
    echo "$1"
}

summary_test() {
    if [[ "$2" == "$3" ]]; then
        github_summary "| $1 | ✅ |"
        github_summary "| $2 | $3 |"
    else
        github_summary "| $1 | ☠ |"
        github_summary "| $2 | $3 |"
    fi
}

cutbox=build/Release/cutbox

cd cutbox_command || exit 1
xcodebuild || exit 1

if [[ ! -e $cutbox ]]; then
    exit 1
fi

github_summary "$($cutbox --help)"

date_hour_ago=$(TZ=UTC gdate -d "-1 hour" +%Y-%m-%dT%H:%M:%SZ)
date_day_ago=$(TZ=UTC gdate -d "-1 day" +%Y-%m-%dT%H:%M:%SZ)

# Fake history item via macos defaults write command line:
defaults write info.ocodo.cutbox historyStore -array-add "<dict><key>string</key><string>Test Passed?</string><key>favorite</key><string>favorite</string></dict>"
defaults write info.ocodo.cutbox historyStore -array-add "<dict><key>string</key><string>Copied Text</string><key>timestamp</key><string>${date_hour_ago}</string></dict>"
defaults write info.ocodo.cutbox historyStore -array-add "<dict><key>string</key><string>Copied text</string><key>timestamp</key><string>${date_day_ago}</string></dict>"

github_summary "# CutBox CLI Tests"
github_summary \
"| Test |  |
|------|--|"

summary_test \
"- \`cutbox\`" \
"$($cutbox)" \
"Test Passed?
Copied Text
Copied text"

summary_test "\`cutbox --fuzzy text\`" \
"$($cutbox --fuzzy text)" \
"Copied text"

summary_test "\`cutbox --fuzzy zoo\`" \
"$($cutbox --fuzzy zoo)" \
""

summary_test "\`cutbox --regex Text\`" \
"$($cutbox --regex Text)" \
"Copied Text"

summary_test "\`cutbox --regexi Text\`" \
"$($cutbox --regexi Text)" \
"Copied Text
Copied text"

summary_test "\`cutbox --favorites\`" \
"$($cutbox --favorites)" \
"Test Passed?"

summary_test "\`cutbox --missing-date\`" \
"$($cutbox --missing-date)" \
"Test Passed?"

summary_test "\`cutbox --since 61mins\`" \
"$($cutbox --since 61mins)" \
"Test Passed?
Copied Text"

summary_test "\`cutbox --since 1.1day\`" \
"$($cutbox --since 1.1day)" \
"Test Passed?
Copied Text
Copied text"

summary_test "\`cutbox --before 1.1hour\`" \
"$($cutbox --before 1.1hour)" \
"Test Passed?
Copied text"

summary_test "\`cutbox --before 1.1day\`" \
"$($cutbox --before 1.1day)" \
"Test Passed?"

[[ "$(grep "☠" "$GITHUB_STEP_SUMMARY")" == "" ]]  ||  exit 1
