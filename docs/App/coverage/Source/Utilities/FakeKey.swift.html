<!DOCTYPE html>
<html><head><meta content="width=device-width,initial-scale=1" name="viewport"/><meta charset="utf-8"/><link href="../../../style.css" rel="stylesheet" type="text/css"/></head><body><h1>CutBox.app</h1><h2>Coverage Report</h2><h4>Created: 2023-09-13 07:47</h4><div class="centered"><table><div class="source-name-title"><pre>.../Source/Utilities/FakeKey.swift</pre></div><tr><td><pre>Line</pre></td><td><pre>Count</pre></td><td><pre>Source (<a href="#L18">jump to first uncovered line</a>)</pre></td></tr><tr><td class="line-number"><a href="#L1" name="L1"><pre>1</pre></a></td><td class="uncovered-line"></td><td class="code"><pre>//</pre></td></tr><tr><td class="line-number"><a href="#L2" name="L2"><pre>2</pre></a></td><td class="uncovered-line"></td><td class="code"><pre>//  FakeKeyEvents.swift</pre></td></tr><tr><td class="line-number"><a href="#L3" name="L3"><pre>3</pre></a></td><td class="uncovered-line"></td><td class="code"><pre>//  CutBox</pre></td></tr><tr><td class="line-number"><a href="#L4" name="L4"><pre>4</pre></a></td><td class="uncovered-line"></td><td class="code"><pre>//</pre></td></tr><tr><td class="line-number"><a href="#L5" name="L5"><pre>5</pre></a></td><td class="uncovered-line"></td><td class="code"><pre>//  Created by Jason Milkins on 26/3/18.</pre></td></tr><tr><td class="line-number"><a href="#L6" name="L6"><pre>6</pre></a></td><td class="uncovered-line"></td><td class="code"><pre>//  Copyright Â© 2018-2023 ocodo. All rights reserved.</pre></td></tr><tr><td class="line-number"><a href="#L7" name="L7"><pre>7</pre></a></td><td class="uncovered-line"></td><td class="code"><pre>//</pre></td></tr><tr><td class="line-number"><a href="#L8" name="L8"><pre>8</pre></a></td><td class="uncovered-line"></td><td class="code"><pre></pre></td></tr><tr><td class="line-number"><a href="#L9" name="L9"><pre>9</pre></a></td><td class="uncovered-line"></td><td class="code"><pre>import Foundation</pre></td></tr><tr><td class="line-number"><a href="#L10" name="L10"><pre>10</pre></a></td><td class="uncovered-line"></td><td class="code"><pre>import Carbon</pre></td></tr><tr><td class="line-number"><a href="#L11" name="L11"><pre>11</pre></a></td><td class="uncovered-line"></td><td class="code"><pre></pre></td></tr><tr><td class="line-number"><a href="#L12" name="L12"><pre>12</pre></a></td><td class="uncovered-line"></td><td class="code"><pre>class FakeKey {</pre></td></tr><tr><td class="line-number"><a href="#L13" name="L13"><pre>13</pre></a></td><td class="uncovered-line"></td><td class="code"><pre></pre></td></tr><tr><td class="line-number"><a href="#L14" name="L14"><pre>14</pre></a></td><td class="uncovered-line"></td><td class="code"><pre>    static let shared = FakeKey()</pre></td></tr><tr><td class="line-number"><a href="#L15" name="L15"><pre>15</pre></a></td><td class="uncovered-line"></td><td class="code"><pre></pre></td></tr><tr><td class="line-number"><a href="#L16" name="L16"><pre>16</pre></a></td><td class="covered-line"><pre>1</pre></td><td class="code"><pre>    private let keyCodeRange = 0x00...0x7E</pre></td></tr><tr><td class="line-number"><a href="#L17" name="L17"><pre>17</pre></a></td><td class="uncovered-line"></td><td class="code"><pre></pre></td></tr><tr><td class="line-number"><a href="#L18" name="L18"><pre>18</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre>    func send(fakeKey key: String, useCommandFlag: Bool) <span class="red">{</span></pre></td></tr><tr><td class="line-number"><a href="#L19" name="L19"><pre>19</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        let keyCode = stringToKeyCode(key)</span></pre></td></tr><tr><td class="line-number"><a href="#L20" name="L20"><pre>20</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        send(fakeKey: numericCast(keyCode), useCommandFlag: useCommandFlag)</span></pre></td></tr><tr><td class="line-number"><a href="#L21" name="L21"><pre>21</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">    }</span></pre></td></tr><tr><td class="line-number"><a href="#L22" name="L22"><pre>22</pre></a></td><td class="uncovered-line"></td><td class="code"><pre></pre></td></tr><tr><td class="line-number"><a href="#L23" name="L23"><pre>23</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre>    private func transformKeyCode(_ keyCode: Int) -&gt; String <span class="red">{</span></pre></td></tr><tr><td class="line-number"><a href="#L24" name="L24"><pre>24</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        guard keyCodeRange.contains(keyCode)</span></pre></td></tr><tr><td class="line-number"><a href="#L25" name="L25"><pre>25</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">            else </span><span class="red">{ fatalError(</span><span class="red">"Cannot transform \(keyCode) - out of range"</span><span class="red">) }</span><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L26" name="L26"><pre>26</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L27" name="L27"><pre>27</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        let inputSource = unsafeBitCast(</span></pre></td></tr><tr><td class="line-number"><a href="#L28" name="L28"><pre>28</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">            TISGetInputSourceProperty(</span></pre></td></tr><tr><td class="line-number"><a href="#L29" name="L29"><pre>29</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">                TISCopyCurrentASCIICapableKeyboardLayoutInputSource().takeUnretainedValue(),</span></pre></td></tr><tr><td class="line-number"><a href="#L30" name="L30"><pre>30</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">                kTISPropertyUnicodeKeyLayoutData</span></pre></td></tr><tr><td class="line-number"><a href="#L31" name="L31"><pre>31</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        ), to: CFData.self)</span></pre></td></tr><tr><td class="line-number"><a href="#L32" name="L32"><pre>32</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L33" name="L33"><pre>33</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        var deadKeyState: UInt32 = 0</span></pre></td></tr><tr><td class="line-number"><a href="#L34" name="L34"><pre>34</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        var char = UniChar()</span></pre></td></tr><tr><td class="line-number"><a href="#L35" name="L35"><pre>35</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        var length = 0</span></pre></td></tr><tr><td class="line-number"><a href="#L36" name="L36"><pre>36</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L37" name="L37"><pre>37</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        CoreServices.UCKeyTranslate(unsafeBitCast(CFDataGetBytePtr(inputSource),</span></pre></td></tr><tr><td class="line-number"><a href="#L38" name="L38"><pre>38</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">                                                  to: UnsafePointer&lt;CoreServices.UCKeyboardLayout&gt;.self),</span></pre></td></tr><tr><td class="line-number"><a href="#L39" name="L39"><pre>39</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">                                    UInt16(keyCode),</span></pre></td></tr><tr><td class="line-number"><a href="#L40" name="L40"><pre>40</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">                                    UInt16(CoreServices.kUCKeyActionDisplay),</span></pre></td></tr><tr><td class="line-number"><a href="#L41" name="L41"><pre>41</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">                                    UInt32(0),</span></pre></td></tr><tr><td class="line-number"><a href="#L42" name="L42"><pre>42</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">                                    UInt32(LMGetKbdType()),</span></pre></td></tr><tr><td class="line-number"><a href="#L43" name="L43"><pre>43</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">                                    OptionBits(CoreServices.kUCKeyTranslateNoDeadKeysBit),</span></pre></td></tr><tr><td class="line-number"><a href="#L44" name="L44"><pre>44</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L45" name="L45"><pre>45</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">                                    &amp;deadKeyState,</span></pre></td></tr><tr><td class="line-number"><a href="#L46" name="L46"><pre>46</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">                                    1,</span></pre></td></tr><tr><td class="line-number"><a href="#L47" name="L47"><pre>47</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">                                    &amp;length,</span></pre></td></tr><tr><td class="line-number"><a href="#L48" name="L48"><pre>48</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">                                    &amp;char)</span></pre></td></tr><tr><td class="line-number"><a href="#L49" name="L49"><pre>49</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L50" name="L50"><pre>50</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        return NSString(characters: &amp;char, length: length).uppercased</span><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L51" name="L51"><pre>51</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">    }</span></pre></td></tr><tr><td class="line-number"><a href="#L52" name="L52"><pre>52</pre></a></td><td class="uncovered-line"></td><td class="code"><pre></pre></td></tr><tr><td class="line-number"><a href="#L53" name="L53"><pre>53</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre>    private func keyCodeTranslationTable() -&gt; [String: Int] <span class="red">{</span></pre></td></tr><tr><td class="line-number"><a href="#L54" name="L54"><pre>54</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        var table = [String: Int]()</span></pre></td></tr><tr><td class="line-number"><a href="#L55" name="L55"><pre>55</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        for code in keyCodeRange </span><span class="red">{</span></pre></td></tr><tr><td class="line-number"><a href="#L56" name="L56"><pre>56</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">            table[transformKeyCode(code)] = code</span></pre></td></tr><tr><td class="line-number"><a href="#L57" name="L57"><pre>57</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        }</span><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L58" name="L58"><pre>58</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        return table</span><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L59" name="L59"><pre>59</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">    }</span></pre></td></tr><tr><td class="line-number"><a href="#L60" name="L60"><pre>60</pre></a></td><td class="uncovered-line"></td><td class="code"><pre></pre></td></tr><tr><td class="line-number"><a href="#L61" name="L61"><pre>61</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre>    private func stringToKeyCode(_ key: String) -&gt; Int <span class="red">{</span></pre></td></tr><tr><td class="line-number"><a href="#L62" name="L62"><pre>62</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        guard key.count == 1 else </span><span class="red">{ fatalError(</span><span class="red">"Only single char strings can be used"</span><span class="red">) }</span><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L63" name="L63"><pre>63</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L64" name="L64"><pre>64</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        let translationTable = keyCodeTranslationTable()</span></pre></td></tr><tr><td class="line-number"><a href="#L65" name="L65"><pre>65</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L66" name="L66"><pre>66</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        guard let keyCode = translationTable[key]</span></pre></td></tr><tr><td class="line-number"><a href="#L67" name="L67"><pre>67</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">            else </span><span class="red">{ fatalError(</span><span class="red">"Unable to get keyCode for: \(key)"</span><span class="red">) }</span><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L68" name="L68"><pre>68</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L69" name="L69"><pre>69</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        return keyCode</span><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L70" name="L70"><pre>70</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">    }</span></pre></td></tr><tr><td class="line-number"><a href="#L71" name="L71"><pre>71</pre></a></td><td class="uncovered-line"></td><td class="code"><pre></pre></td></tr><tr><td class="line-number"><a href="#L72" name="L72"><pre>72</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre>    private func send(fakeKey keyCode: CGKeyCode, useCommandFlag: Bool) <span class="red">{</span></pre></td></tr><tr><td class="line-number"><a href="#L73" name="L73"><pre>73</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        let sourceRef = CGEventSource(stateID: .combinedSessionState)</span></pre></td></tr><tr><td class="line-number"><a href="#L74" name="L74"><pre>74</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L75" name="L75"><pre>75</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        if </span><span class="red">sourceRef == nil</span><span class="red"> </span><span class="red">{</span></pre></td></tr><tr><td class="line-number"><a href="#L76" name="L76"><pre>76</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">            NSLog("No event source")</span></pre></td></tr><tr><td class="line-number"><a href="#L77" name="L77"><pre>77</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">            return</span></pre></td></tr><tr><td class="line-number"><a href="#L78" name="L78"><pre>78</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        }</span><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L79" name="L79"><pre>79</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L80" name="L80"><pre>80</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        let keyDownEvent = CGEvent(</span></pre></td></tr><tr><td class="line-number"><a href="#L81" name="L81"><pre>81</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">            keyboardEventSource: sourceRef,</span></pre></td></tr><tr><td class="line-number"><a href="#L82" name="L82"><pre>82</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">            virtualKey: keyCode,</span></pre></td></tr><tr><td class="line-number"><a href="#L83" name="L83"><pre>83</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">            keyDown: true</span></pre></td></tr><tr><td class="line-number"><a href="#L84" name="L84"><pre>84</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        )</span></pre></td></tr><tr><td class="line-number"><a href="#L85" name="L85"><pre>85</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L86" name="L86"><pre>86</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        if </span><span class="red">useCommandFlag</span><span class="red"> </span><span class="red">{</span></pre></td></tr><tr><td class="line-number"><a href="#L87" name="L87"><pre>87</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">            keyDownEvent?.flags = .maskCommand</span></pre></td></tr><tr><td class="line-number"><a href="#L88" name="L88"><pre>88</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        }</span><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L89" name="L89"><pre>89</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L90" name="L90"><pre>90</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        let keyUpEvent = CGEvent(</span></pre></td></tr><tr><td class="line-number"><a href="#L91" name="L91"><pre>91</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">            keyboardEventSource: sourceRef,</span></pre></td></tr><tr><td class="line-number"><a href="#L92" name="L92"><pre>92</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">            virtualKey: keyCode,</span></pre></td></tr><tr><td class="line-number"><a href="#L93" name="L93"><pre>93</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">            keyDown: false</span></pre></td></tr><tr><td class="line-number"><a href="#L94" name="L94"><pre>94</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        )</span></pre></td></tr><tr><td class="line-number"><a href="#L95" name="L95"><pre>95</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red"></span></pre></td></tr><tr><td class="line-number"><a href="#L96" name="L96"><pre>96</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        keyDownEvent?.post(tap: .cghidEventTap)</span></pre></td></tr><tr><td class="line-number"><a href="#L97" name="L97"><pre>97</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">        keyUpEvent?.post(tap: .cghidEventTap)</span></pre></td></tr><tr><td class="line-number"><a href="#L98" name="L98"><pre>98</pre></a></td><td class="uncovered-line"><pre>0</pre></td><td class="code"><pre><span class="red">    }</span></pre></td></tr><tr><td class="line-number"><a href="#L99" name="L99"><pre>99</pre></a></td><td class="uncovered-line"></td><td class="code"><pre>}</pre></td></tr></table></div></body></html>